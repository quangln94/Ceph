# Backup VM Openstack sử dụng Ceph-snapshot

## 1. Backup Full

### 1.1 Tạo VM boot từ volume trên hệ thống Openstack
Volume có ID là: e3e51421-0294-4271-bb07-033e3f8d6ef0

<img src=https://i.imgur.com/wQuRIgz.png>

### 1.2 Kiểm tra dưới hệ thống Ceph
```sh
$ rbd -p volumes ls | grep e3e51421-0294-4271-bb07-033e3f8d6ef0
```
<img src=https://i.imgur.com/Tk2WWdF.png>

**Thực hiện ghi dữ liệu vào VM, tắt VM và tạo bản backup full đầu tiên**

<img src=https://i.imgur.com/2xH9gtS.png>

```sh
cinder --insecure backup-create --force e3e51421-0294-4271-bb07-033e3f8d6ef0
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, không có bản snapshot nào được tạo ra
```sh
rbd snap ls volumes/volume-e3e51421-0294-4271-bb07-033e3f8d6ef0
```
- Kiểm tra pool backups, xuất hiện image tương ứng với bản backup vửa tạo, image này không có bản backups nào
```sh
rbd -p backups ls
rbs snap ls backups/volume-e3e51421-0294-4271-bb07-033e3f8d6ef0.backup.19b90a2c-1ae0-4833-8ca6-8ca270f1c1cf
```

<img src=https://i.imgur.com/7OfVCpC.png>
**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản snapshot thứ 1**

<img src=https://i.imgur.com/8k82Jq3.png>

```sh
cinder --insecure snapshot-create --force e3e51421-0294-4271-bb07-033e3f8d6ef0 --name snap01-vmcent
```

**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản snapshot vừa tạo
```sh
rbd snap ls volumes/volume-e3e51421-0294-4271-bb07-033e3f8d6ef0
```
<img src=https://i.imgur.com/RXGPAGF.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản backup incremental thứ 1 từ bản backup full thứ 1**

<img src=https://i.imgur.com/94oWJBU.png>

```sh
cinder --insecure backup-create e3e51421-0294-4271-bb07-033e3f8d6ef0 --incremental --force
```

**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup vừa tạo, tuy nhiên sau đó bản snapshot này bị mất khi bản backup được tạo xong
```sh
rbd snap ls volumes/volume-e3e51421-0294-4271-bb07-033e3f8d6ef0
```
<img src=https://i.imgur.com/yIRiM6Q.png>

- Kiểm tra pool backups, xuất hiện image tương ứng với bản backup vửa tạo, image này không có bản snapshot nào
```sh
rbd -p backups ls
rbd snap ls backups/volume-e3e51421-0294-4271-bb07-033e3f8d6ef0.backup.a9ac0e2e-3c87-44b3-a686-ac41094a4ad9
```
<img src=https://i.imgur.com/LbhMnUz.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản backup full thứ 2**

**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool backups, xuất hiện image tương ứng với bản backup vửa tạo, image này không có bản snapshot nào
```sh
rbd -p backups ls
rbd snaps ls backups/volume-e3e51421-0294-4271-bb07-033e3f8d6ef0.backup.497d2874-66ca-4d39-86d3-381878db066e
```
<img src=https://i.imgur.com/LbhMnUz.png>
