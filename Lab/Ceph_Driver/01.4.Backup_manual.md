# Backup VM Openstack sử dụng Ceph-snapshot

## 1. Backup Full

### 1.1 Tạo VM boot từ volume trên hệ thống Openstack
Volume có ID là: 21bca525-f728-4484-a59c-62b134db6a08

<img src=https://i.imgur.com/zKFSfNP.png>

### 1.2 Kiểm tra dưới hệ thống Ceph
```sh
$ rbd -p volumes ls | grep 21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/exPTtYq.png>

**Thực hiện ghi dữ liệu vào VM, tắt VM và tạo bản backup full thứ 1**

<img src=https://i.imgur.com/t34ZocK.png>

```sh
cinder --insecure backup-create --force 21bca525-f728-4484-a59c-62b134db6a08
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra sau đó mất và đồng thời tại pool backup xuất hiển image tương ứng với bản backup vừa tạo.
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/ASQrrB1.png>

- Kiểm tra pool backups, xuất hiện image tương ứng với bản backup vửa tạo, image này không có bản snapshot nào
```sh
rbd -p backups ls
rbs snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.9693810a-4103-48f0-b1f1-b0255e2bf3bb
```

<img src=https://i.imgur.com/8WCyvYG.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản snapshot thứ 1**

<img src=https://i.imgur.com/ejsWna4.png>

```sh
cinder --insecure snapshot-create 21bca525-f728-4484-a59c-62b134db6a08 --name snap01-vmcirros --force
```

**Kiểm tra dưới hệ thống Ceph**

- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản snapshot vừa tạo
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/0ea1uGX.png>


**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản backup incremental thứ 1 từ bản backup full thứ 1**

<img src=https://i.imgur.com/8hrZPaa.png>

```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --incremental --force
```

**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup vừa tạo, tuy nhiên sau đó bản snapshot này bị mất khi bản backup được tạo xong
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/gBCefq1.png>

- Kiểm tra pool backups, xuất hiện image tương ứng với bản backup vửa tạo, image này không có bản snapshot nào
```sh
rbd -p backups ls
rbd snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.a9ac0e2e-3c87-44b3-a686-ac41094a4ad9
```
<img src=https://i.imgur.com/URoELLn.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản backup full thứ 2**

<img src=https://i.imgur.com/hJW89Ty.png>
```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --force
```

**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup vừa tạo, tuy nhiên sau đó bản snapshot này bị mất khi bản backup được tạo xong
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/zHeC9tV.png>

- Kiểm tra pool backups, xuất hiện image tương ứng với bản backup vửa tạo, image này không có bản snapshot nào
```sh
rbd -p backups ls
rbd snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.49b7df4b-4380-4a83-a201-3e180e9e10c4
```
<img src=https://i.imgur.com/4rstfzV.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản snapshot thứ 2**
<img src=https://i.imgur.com/nVa9hCb.png>
```sh
cinder --insecure snapshot-create 21bca525-f728-4484-a59c-62b134db6a08 --name snap02-vmcirros --force
```

**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản snapshot vừa tạo
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/LDb59iq.png>

**Thực hiện restore về bản backup thứ 1, ghi dữ liệu, tắt VM, tạo bản backup full thứ 3**
<img src=https://i.imgur.com/Yz4uKWG.png>
```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --force
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup thứ 3 vừa tạo
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/qlyFtTM.png>

- Kiểm tra pool backups, xuất hiện image tương ứng với bản backup vửa tạo, image này có tên đặc biết là `...base`. Image này có bản snapshot tương với với bản snapshot tạo tạo pool volume

```sh
rbd -p backups ls
rbd snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.base
```
<img src=https://i.imgur.com/NSsKVQJ.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản snapshot thứ 3**
<img src=https://i.imgur.com/Op2o0PE.png>
```sh
cinder --insecure snapshot-create --force --name snap03-vmcent 21bca525-f728-4484-a59c-62b134db6a08
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản snapshot thứ 3 vừa tạo
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/G8C81iF.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản backup thứ 4**
<img src=https://i.imgur.com/v9u80a6.png>
```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --force
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup thứ 4 vừa tạo, đồng thời bản backup thứ 3 trước đó đã mất
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/7HjYtuk.png>

- Kiểm tra pool backups, không xuất hiện thêm image nào, kiểm tra image `base` thấy xuất hiện thêm bản snapshot tương ứng với bản backup thứ 4 vừa tạo đồng thời vẫn giữa bản snapshot tương ứng với bản backup thứ 3
```sh
rbd -p backups ls
rbd snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.base
```
<img src=https://i.imgur.com/hI5mJgB.png>

**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản snapshot thứ 4**
<img src=https://i.imgur.com/fkmWIA4.png>

```sh
cinder --insecure snapshot-create --force --name snap04-vmcent 21bca525-f728-4484-a59c-62b134db6a08
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản snapshot thứ 4 vừa tạo
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/mF1osD3.png>






**Thực hiện bật VM, ghi dữ liệu, tắt VM và tạo bản backup full thứ 5**
<img src=https://i.imgur.com/k2yBoxw.png>

```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --force
```

**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup thứ 5 vừa tạo, đồng thời bản backup thứ 4 trước đó đã mất
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```

<img src=https://i.imgur.com/FK463Qs.png>

- Kiểm tra pool backups, không xuất hiện thêm image nào, kiểm tra image `base` thấy xuất hiện thêm bản snapshot tương ứng với bản backup thứ 5 vừa tạo đồng thời vẫn giữa bản snapshot tương ứng với bản backup thứ 4
```sh
rbd -p backups ls
rbd snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.base
```
<img src=https://i.imgur.com/gGJpJil.png>

**Thực hiện restore về bản backup thứ 2, ghi dữ liệu, tắt VM, tạo bản backup full thứ 6**
<img src=https://i.imgur.com/Ef6LPql.png>

```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --force
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup thứ 6 vừa tạo, đồng thời bản backup thứ 5 trước đó đã mất
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/9kPBPv1.png>
- Kiểm tra pool backups, không xuất hiện thêm image nào, kiểm tra image `base` thấy xuất hiện thêm bản snapshot tương ứng với bản backup thứ 6 vừa tạo đồng thời vẫn giữa bản snapshot tương ứng với bản backup thứ 5
```sh
rbd -p backups ls
rbd snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.base
```
<img src=https://i.imgur.com/2cawsQy.png>

**Thực hiện restore về bản backup thứ 4, ghi dữ liệu, tắt VM, tạo bản backup full thứ 7**
<img src=https://i.imgur.com/Qv7ArsD.png>
```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --force
```
**Kiểm tra dưới hệ thống Ceph**
- Kiểm tra pool volume, có bản snapshot được tạo ra tương ứng với bản backup thứ 7 vừa tạo, đồng thời bản backup thứ 6 trước đó đã mất
```sh
rbd snap ls volumes/volume-21bca525-f728-4484-a59c-62b134db6a08
```
<img src=https://i.imgur.com/Tr3jGLq.png>

- Kiểm tra pool backups, không xuất hiện thêm image nào, kiểm tra image `base` thấy xuất hiện thêm bản snapshot tương ứng với bản backup thứ 7 vừa tạo đồng thời vẫn giữa bản snapshot tương ứng với bản backup thứ 6
```sh
rbd -p backups ls
rbd snap ls backups/volume-21bca525-f728-4484-a59c-62b134db6a08.backup.base
```
<img src=https://i.imgur.com/EJwui44.png>


**Thực hiện restore về bản backup thứ 5, ghi dữ liệu, tắt VM, tạo bản backup full thứ 8**
<img src=https://i.imgur.com/4UJdlQ0.png>
```sh
cinder --insecure backup-create 21bca525-f728-4484-a59c-62b134db6a08 --force
```
