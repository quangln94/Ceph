# Triển khai Cluster Ceph sử dụng Ceph-ansible

## 1. Chuẩn bị
### 1.1 Clone repo git
```
git clone https://github.com/ceph/ceph-ansible.git
cd ceph-ansible
git checkout stable-4.0
```
### 1.2. Cài các thư viện Python libraries cần thiết:
```sh
pip install -r requirements.txt
```
## 2. Thực hiện 1 số bài LAB
### 2.1 Cài đặt Cluster Ceph
- Copy ssh-key sang các Node Ceph
```sh
ssh-copy-id mon1
ssh-copy-id mon2
ssh-copy-id mon3
ssh-copy-id osd1
ssh-copy-id osd2
ssh-copy-id osd3
```
- Tạo file `inventory` khai báo các Node Ceph
```sh
cat << EOF >> inventory
[mons]
mon1
mon2
mon3

[mgrs]
mon1
mon2
mon3

[osds]
osd1
osd2
osd3

[grafana-server]
mon01
EOF
```
- Tạo `playbook` sử dụng sample sẵn có
```sh
cp site.yml.sample playbook-ceph.yml
```
- Khai báp `group_vars`
Chỉnh sử file `all.yml` với nội dung sau:
```sh
ceph_origin: repository
ceph_repository: community
ceph_stable_release: nautilus
public_network: "192.168.1.0/24"
cluster_network: "172.16.1.0/24"
monitor_interface: eth0
devices:
  - '/dev/sda'
  - '/dev/sdb'
```
- Khởi tạo Cluster Ceph
```sh
cd ansible-ceph
ansible-playbook playbook-ceph.yml -i inventory
```
### 2.2 Thêm OSD vào Cluster

Để thêm Node OSD vào CLuster, thực hiện khai báo file `inventory` thêm Node mới và comment các Node đã Deploy tương tự như sau:
```sh
vim ceph-ansible/inventory
[mons]
mon1
mon2
mon3

[mgrs]
mon1
mon2
mon3

[osds]
#osd1
#osd2
#osd3
osd4
[grafana-server]
mon01
EOF
```
- Chỉnh sửa file ceph-ansilbe/groups_vars/all.yml với các disk nếu cần
- Thực hiện add Node vào Cluster 
```sh
cd ceph-ansible
ansible-playbook ceph-ansible/infrastructure-playbooks/add-osd.yml -i ceph-ansible/inventory
```
### 2.3 Xóa OSD khởi Cluster

Xóa OSD khởi Cluster như sau:
```sh
ansible-playbook ceph-ansible/infrastructure-playbooks/shrink-osd.yml -e osd_to_kill=0,2,6
```
Trong đó:
 - 0,2,6: là ID của OSD tương ứng
 
### 2.4 Deploy OSD sử dụng backend là Bluestore

### 2.5 Deploy OSD sử dụng backend là Filestore

### 2.6 Thêm các tùy chọn khác

## Tài liệu tham khảo 
- https://github.com/ceph/ceph-ansible.git
- https://docs.ceph.com/ceph-ansible/master/
